@page "/profile/appearance"

@using Banko.Client.Models.User
@using Banko.Client.Services.User
@using Banko.Client.Services.Auth
@using Banko.Client.Services

@inject UserStateService UserState
@inject LoadingService LoadingService
@inject ISnackbar Snackbar
@inject AuthStateProvider AuthState

<MudPaper Class="pa-4" Elevation="0">
  <MudItem xs="12" Class="d-flex justify-space-between">
    <MudText Typo="Typo.h5">Appearance Settings</MudText>
    <MudItem Style="height: 50px;">
      @if (isInitialized && AuthState.UserPreferences.DarkMode != _originalTheme)
      {
        <MudButton DropShadow="false" Variant="Variant.Filled" Color="Color.Dark" OnClick="HandleSaveAsync" Class="mr-2"
          Disabled="LoadingService.IsLoading">Save</MudButton>
        <MudButton DropShadow="false" Variant="Variant.Filled" Color="Color.Default" OnClick="CancelEdit"
          Disabled="LoadingService.IsLoading">
          Cancel</MudButton>
      }
    </MudItem>
  </MudItem>

  <MudGrid Class="mt-4">
    <MudItem>
      <MudSwitch T="bool" Color="Color.Primary" Value="AuthState.UserPreferences.DarkMode"
        ValueChanged="OnThemeSwitchChanged">
        @(AuthState.UserPreferences.DarkMode ? "Dark Mode" : "Light Mode")
      </MudSwitch>
    </MudItem>
  </MudGrid>
</MudPaper>

@code {
  private bool isInitialized = false;
  private bool _originalTheme;
  protected override void OnAfterRender(bool firstRender)
  {
    if (firstRender)
    {
      _originalTheme = AuthState.UserPreferences.DarkMode;
      isInitialized = true;
    }
  }
  private void OnThemeSwitchChanged(bool newValue)
  {
    AuthState.UserPreferences.DarkMode = newValue;
    StateHasChanged();
    AuthState.NotifyPreferencesChanged();
  }
  private async Task HandleSaveAsync()
  {
    LoadingService.IsLoading = true;
    var success = await UserState.UpdatePreference(AuthState.UserPreferences);

    if (success)
    {
      _originalTheme = AuthState.UserPreferences.DarkMode;
      Snackbar.Add("Appearance settings saved.", Severity.Success);
    }
    else
    {
      Snackbar.Add("Failed to update appearance settings.", Severity.Error);
    }
    LoadingService.IsLoading = false;
  }
  private void CancelEdit()
  {
    AuthState.UserPreferences.DarkMode = _originalTheme;
    StateHasChanged();
    AuthState.NotifyPreferencesChanged();
  }
}