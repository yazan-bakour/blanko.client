@page "/Login"
@using Banko.Client.Models
@using Banko.Client.Services.User
@inject UserStateService UserState
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudCard Elevation="25" Class="pa-4">
  <MudCardHeader>
    <MudText Typo="Typo.h5" Align="Align.Center">Login</MudText>
  </MudCardHeader>
  <MudCardContent>
    <MudForm Model="@loginModel" @ref="form" @bind-IsValid="@success">
      <MudTextField Label="Email" @bind-Value="loginModel.Email" For="@(() => loginModel.Email)" Immediate="true"
        Required />
      <MudTextField Label="Password" @bind-Value="loginModel.Password" For="@(() => loginModel.Password)"
        Immediate="true" Required />
    </MudForm>
  </MudCardContent>
  <MudCardActions Class="d-flex justify-center">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="px-8" Size="Size.Large"
      Disabled="@(!success || isLoading)" OnClick="HandleLogin">
      @if (isLoading)
      {
        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
        <MudText Class="ms-2">Processing</MudText>
      }
      else
      {
        <MudText>Login</MudText>
      }
    </MudButton>
  </MudCardActions>
</MudCard>

@code {
  private UserLogin loginModel = new();
  private bool success;
  private MudForm form;
  private bool isLoading = false;

  private async Task HandleLogin()
  {
    await form.Validate();
    if (form.IsValid)
    {
      try
      {
        isLoading = true;
        await UserState.LoginAsync(loginModel);
        Snackbar.Add("Login successful!", Severity.Success);
        NavigationManager.NavigateTo("/");
      }
      catch (Exception ex)
      {
        Snackbar.Add(ex.Message, Severity.Error);
      }
      finally
      {
        isLoading = false;
      }
    }
  }
}