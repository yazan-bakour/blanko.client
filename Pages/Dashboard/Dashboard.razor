@page "/dashboard"

@using Banko.Client.Models.Account
@using Banko.Client.Models.Transaction
@using Banko.Client.Models.User
@using Microsoft.AspNetCore.Authorization
@using Banko.Client.Services.User
@using Banko.Client.Services.Account
@using Banko.Client.Services.Transaction
@using System.Globalization
@using Banko.Client.Pages.Dashboard.components

@inject LoadingService LoadingService
@inject UserStateService UserState
@inject AccountStateService AccountState
@inject TransactionStateService TransactionState
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@attribute [Authorize]

<MudGrid>
  <!-- User welcome and summary -->
  <MudItem xs="12" sm="6" md="4">
    <Welcome name="@currentUser?.User.FullName" createdAt="@currentUser?.User.CreatedAt" transactions="transactions" />
  </MudItem>

  <!-- Accounts Summary -->
  <MudItem xs="12" sm="6" md="4">
    <AccountSummery accounts="accounts" />
  </MudItem>

  <!-- Total Balance -->
  <MudItem xs="12" sm="12" md="4">
    <MudGrid>
      <MudItem xs="12" sm="6" md="12">
        <TotalBalance accounts="accounts" />
      </MudItem>
      <MudItem xs="12" sm="6" md="12">
        <AccountInsights accounts="accounts" />
      </MudItem>
    </MudGrid>
  </MudItem>

  <!-- Recent Activity -->
  <MudItem xs="12" sm="12" md="4">
    <MudGrid>
      <MudItem xs="12" sm="6" md="12">
        <RecentActivity transactions="transactions" />
      </MudItem>
      <MudItem xs="12" sm="6" md="12">
        <MonthlySpending transactions="transactions" />
      </MudItem>
    </MudGrid>
  </MudItem>

  <!-- Recent Transactions Table -->
  <MudItem xs="12" sm="12" md="8">
    <RecentTransactions transactions="transactions" />
  </MudItem>

  <!-- Stacked bar Chart -->
  <MudItem xs="12" sm="12" md="8">
    <StackedBarChart transactions="transactions?.ToList()" accounts="accounts?.ToList()" />
  </MudItem>

  <!-- Upcoming -->
  <MudItem xs="12" sm="12" md="4">
    <MudGrid>
      <MudItem xs="12" sm="6" md="12">
        <MudPaper Class="pa-4" Style="height: 212px;" Elevation="0">
          <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.SignalWifiStatusbarConnectedNoInternet4" Class="mr-2" />
            Status
          </MudText>
        </MudPaper>
      </MudItem>
      <MudItem xs="12" sm="6" md="12">
        <MudPaper Class="pa-4" Style="height: 212px;" Elevation="0">
          <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.BrowserUpdated" Class="mr-2" />
            Updated at
          </MudText>
        </MudPaper>
      </MudItem>
    </MudGrid>
  </MudItem>

  <MudItem xs="12" sm="6" md="4">
    <MudPaper Class="pa-4" Style="height: 200px;" Elevation="0"></MudPaper>
  </MudItem>
  <MudItem xs="12" sm="6" md="4">
    <MudPaper Class="pa-4" Style="height: 200px;" Elevation="0"></MudPaper>
  </MudItem>
  <MudItem xs="12" sm="12" md="4">
    <MudPaper Class="pa-4" Style="height: 200px;" Elevation="0"></MudPaper>
  </MudItem>
</MudGrid>

@code {
  private UserRead? currentUser;
  private AccountRead[]? accounts;
  private TransactionRead[]? transactions;
  private bool isDataLoaded = false; // use this for Skeleton loading

  private string[] GetAccountLabels()
  {
    if (accounts == null || !accounts.Any()) return Array.Empty<string>();
    return accounts.Select(a => a.AccountNumber).ToArray();
  }
  protected override async Task OnInitializedAsync()
  {
    UserState.OnUserStateChanged += HandleUserStateChanged;
    AccountState.OnAccountStateChanged += HandleAccountStateChanged;
    TransactionState.OnTransactionStateChanged += HandleTransactionStateChanged;

    if (UserState.CurrentUser == null || AccountState.CurrentAccounts == null)
    {
      await LoadInitialDataAsync();
    }
    else
    {
      currentUser = UserState.CurrentUser;
      accounts = AccountState.CurrentAccounts;
      transactions = TransactionState.CurrentTransactions;
      isDataLoaded = true;
    }
  }
  private async Task LoadInitialDataAsync()
  {
    LoadingService.IsLoading = true;

    try
    {
      if (UserState.CurrentUser == null)
      {
        @* await UserState.LoadUserDataAsync(); *@
      }

      currentUser = UserState.CurrentUser;

      if (currentUser != null)
      {
        if (AccountState.CurrentAccounts == null)
        {
          await AccountState.InitializeAccountStateAsync(currentUser.User.Id);
        }
        accounts = AccountState.CurrentAccounts;

        if (TransactionState.CurrentTransactions == null)
        {
          await TransactionState.InitializeTransactionStateAsync();
        }
        transactions = TransactionState.CurrentTransactions;
      }
    }
    catch (Exception ex)
    {
      Snackbar.Add($"Error loading dashboard data: {ex.Message}", Severity.Error);
    }
    finally
    {
      isDataLoaded = true;
      LoadingService.IsLoading = false;
    }
  }

  private void HandleUserStateChanged()
  {
    currentUser = UserState.CurrentUser;
    InvokeAsync(StateHasChanged);
  }

  private void HandleAccountStateChanged()
  {
    accounts = AccountState.CurrentAccounts;
    InvokeAsync(StateHasChanged);
  }

  private void HandleTransactionStateChanged()
  {
    transactions = TransactionState.CurrentTransactions;
    InvokeAsync(StateHasChanged);
  }

  private (double[] data, string[] labels) GetSpendingByCategoryData()
  {
    if (transactions == null || !transactions.Any()) return (Array.Empty<double>(), Array.Empty<string>());

    var thisMonth = DateTime.Now.Month;
    var thisYear = DateTime.Now.Year;

    var spendingByCategory = transactions
    .Where(t => t.TransactionDate.Month == thisMonth &&
    t.TransactionDate.Year == thisYear &&
    (t.Type == TransactionType.Withdrawal || t.Type == TransactionType.Payment))
    .GroupBy(t => t.Type.ToString())
    .Select(g => new { Category = g.Key, Amount = g.Sum(t => (double)t.Amount) })
    .OrderByDescending(x => x.Amount)
    .ToList();

    return (spendingByCategory.Select(x => x.Amount).ToArray(),
    spendingByCategory.Select(x => x.Category).ToArray());
  }

  public void Dispose()
  {
    // Unsubscribe from events
    UserState.OnUserStateChanged -= HandleUserStateChanged;
    AccountState.OnAccountStateChanged -= HandleAccountStateChanged;
    TransactionState.OnTransactionStateChanged -= HandleTransactionStateChanged;
  }
}